<script>
/* --- PARTICLE FON --- */
const canvas=document.getElementById("particles");
const ctx=canvas.getContext("2d");
let W=canvas.width=window.innerWidth;
let H=canvas.height=window.innerHeight;
let particlesArray=[];
class Particle{
  constructor(){this.x=Math.random()*W;this.y=Math.random()*H;this.size=Math.random()*2+1;this.speedX=Math.random()*1-0.5;this.speedY=Math.random()*1-0.5;}
  update(){this.x+=this.speedX;this.y+=this.speedY;if(this.x>W)this.x=0;if(this.x<0)this.x=W;if(this.y>H)this.y=0;if(this.y<0)this.y=H;}
  draw(){ctx.fillStyle='rgba(255,255,255,0.05)';ctx.beginPath();ctx.arc(this.x,this.y,this.size,0,Math.PI*2);ctx.fill();}
}
function initParticles(){particlesArray=[];for(let i=0;i<120;i++){particlesArray.push(new Particle());}}
function animateParticles(){ctx.clearRect(0,0,W,H);particlesArray.forEach(p=>{p.update();p.draw();});requestAnimationFrame(animateParticles);}
window.addEventListener('resize',()=>{W=canvas.width=window.innerWidth;H=canvas.height=window.innerHeight;});
initParticles();animateParticles();

/* --- POEMS --- */
const poemsContainer=document.getElementById("poemsContainer");
const poemTitle=document.getElementById("poemTitle");
const poemText=document.getElementById("poemText");
const poemCategory=document.getElementById("poemCategory");
const adminAdd=document.querySelector(".admin-add");

function renderPoems(){
  poemsContainer.innerHTML="";
  let poems=JSON.parse(localStorage.getItem("poems")||"[]");

  // Popular / Recent
  let popularList=document.getElementById("popularList");
  let recentList=document.getElementById("recentList");
  popularList.innerHTML=""; recentList.innerHTML="";
  let sortedByRandom = [...poems].sort(()=>0.5-Math.random());
  sortedByRandom.slice(0,3).forEach(p=>{
    let div=document.createElement("div"); div.innerText=p.title; popularList.appendChild(div);
  });
  poems.slice(-3).forEach(p=>{
    let div=document.createElement("div"); div.innerText=p.title; recentList.appendChild(div);
  });

  poems.forEach((p,index)=>{
    const div=document.createElement("div");
    div.className="poem";
    div.dataset.category=p.category;
    div.innerHTML=`
      <h2>${p.title}</h2>
      <div class="poem-category">${p.category}</div>
      <pre>${p.text}</pre>
      <div class="poem-actions">
        <div class="stars" data-id="${index}"><span>★</span><span>★</span><span>★</span></div>
        <button class="comment-btn">Şərhlər</button>
        <div class="share-buttons">
          <button onclick="share('facebook',${index})">Facebook</button>
          <button onclick="share('twitter',${index})">Twitter</button>
        </div>
        <button class="delete-btn" data-id="${index}">Sil</button>
      </div>
      <div class="comments-box"><div class="all-comments"></div><textarea placeholder="Şərhini yaz..."></textarea><button class="add-comment">Göndər</button></div>
    `;
    poemsContainer.appendChild(div);
  });
  attachCommentEvents();
}

adminAdd.onclick=()=>{
  const title=poemTitle.value.trim();
  const text=poemText.value.trim();
  const category=poemCategory.value;
  if(!title||!text)return;
  let poems=JSON.parse(localStorage.getItem("poems")||"[]");
  poems.push({title,text,category});
  localStorage.setItem("poems",JSON.stringify(poems));
  poemTitle.value="";poemText.value="";
  renderPoems();
}

/* --- COMMENTS & STARS --- */
function attachCommentEvents(){
  document.querySelectorAll(".comment-btn").forEach(btn=>{
    btn.onclick=()=>{const box=btn.parentElement.nextElementSibling;box.style.display=box.style.display==="block"?"none":"block";}
  });
  document.querySelectorAll(".add-comment").forEach(btn=>{
    btn.onclick=()=>{
      const box=btn.parentElement;
      const text=box.querySelector("textarea").value;
      if(text.trim()==="")return;
      const div=document.createElement("div");
      div.style.padding="6px";div.style.borderBottom="1px solid #333";
      div.innerText="Anonim: "+text;
      box.querySelector(".all-comments").appendChild(div);
      box.querySelector("textarea").value="";
    };
  });
  document.querySelectorAll(".stars").forEach(starBox=>{
    const stars=starBox.querySelectorAll("span");
    stars.forEach((star,idx)=>{
      star.onclick=()=>{
        stars.forEach((s,i)=>s.classList.toggle("active",i<=idx));
      };
    });
  });
  document.querySelectorAll(".delete-btn").forEach(btn=>{
    btn.onclick=()=>{
      let poems=JSON.parse(localStorage.getItem("poems")||"[]");
      poems.splice(btn.dataset.id,1);
      localStorage.setItem("poems",JSON.stringify(poems));
      renderPoems();
    };
  });
}

/* --- SEARCH & CATEGORY FILTER --- */
document.getElementById("searchBox").addEventListener("keyup",function(){
  const text=this.value.toLowerCase();
  document.querySelectorAll(".poem").forEach(p=>{
    p.style.display=p.innerText.toLowerCase().includes(text)?"block":"none";
  });
});
document.getElementById("categoryFilter").addEventListener("change",function(){
  const val=this.value;
  document.querySelectorAll(".poem").forEach(p=>{
    p.style.display=(val==="All"||p.dataset.category===val)?"block":"none";
  });
});

/* --- SUBSCRIBE MODAL --- */
const subscribeModal=document.getElementById("subscribeModal");
document.querySelector(".subscribe-btn").onclick=()=>{subscribeModal.style.display="flex";}
document.getElementById("subscribeBtn").onclick=()=>{
  const email=document.getElementById("subscriberEmail").value;
  if(email.trim()===""){alert("Email daxil edin!");return;}
  alert(`Təşəkkürlər, ${email} abunə oldu!`);
  document.getElementById("subscriberEmail").value="";
  subscribeModal.style.display="none";
};

/* --- SOCIAL SHARE --- */
function share(platform,index){
  const poems=JSON.parse(localStorage.getItem("poems")||"[]");
  const url=encodeURIComponent(window.location.href);
  const text=encodeURIComponent(poems[index].title + "\n\n" + poems[index].text);
  let shareUrl="";
  if(platform==="facebook") shareUrl=`https://www.facebook.com/sharer/sharer.php?u=${url}&quote=${text}`;
  if(platform==="twitter") shareUrl=`https://twitter.com/intent/tweet?text=${text}&url=${url}`;
  window.open(shareUrl,"_blank");
}

/* --- HAMBURGER MENU --- */
const hamburger=document.getElementById("hamburger");
const navMenu=document.getElementById("navMenu");
hamburger.onclick=()=>{navMenu.classList.toggle("show");}

/* --- TOGGLE THEME --- */
const toggleThemeBtn=document.querySelector(".toggle-theme");
toggleThemeBtn.onclick=()=>{
  document.body.classList.toggle("light");
};

/* --- INIT --- */
renderPoems();
</script>
